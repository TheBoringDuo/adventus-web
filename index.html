<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="css/style.css?v=5">
    <script src="js/jquery-3.6.0.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9, user-scalable=no">
    <title>Adventus</title>
</head>
<body>
    <a href="#" class="actionbar-info" onclick="return false;"></a>
    <div class="user-menu">
        <!-- Welcome, <strong>Nicola Nicolov</strong>! -->
        <input id="login-email" type="email" placeholder="E-mail" class="login-input">
        <input id="login-password" type="password" placeholder="Password" class="login-input">
        <button onclick="login();" class="login-button" style="margin-right: 4px;">Login</button>
        <button onclick="alert('register: todo');" class="login-button" style="margin-left: 7.5px;">Register</button>
        <div style="text-align: center; width: 100%; margin-top: 4px; color: rgb(104, 104, 104);"><a href="#" style="font-size: 0.8em;">Forgot Password?</a></div>
    </div>

    <div class="landing-container landing-neg-space" id="landing-container">
        <div class="center-h" style="margin-bottom: 50px;">
            <img src="drawables/adventus.svg" id="main-logo" onclick="hideResults(); return false;" />
        </div>

        <div id="page-zero">
            <label for="textbox-dest" style="margin-left: 92px; font-size: 1.1em; color: #0000007d;">
                your next desired destination:
            </label>
            <div class="center-h autocomplete" style="margin-top: 5px;">
                <input type="text" id="textbox-dest" class="textbox-dest" autocomplete="off" />
            </div>

            <div style="margin-bottom: -22px;" class="keywords">
                <img src="drawables/sliders-h-solid.svg" style="margin-top: 50px; vertical-align:middle; margin-bottom: 46px;" />
                <p style="font-size: 2em; vertical-align:middle; display:inline; margin-left: 5px; color: #000000b0;">keywords</p>
            </div>
            <div style="margin-bottom: 32px;">
                <label for="textbox-prefhotel" style="margin-left: 92px; font-size: 1.1em; color: #0000007d;">
                    for the hotels:
                </label>
                <div class="center-h" style="margin-top: 5px; margin-bottom: 15px;">
                    <input type="text" id="textbox-prefhotel" class="textbox-prefhotel" />
                </div>
                <div style="display: flex;" class="suggestions">
                    <div class="suggestion sg-purple">price</div>
                    <div class="suggestion sg-purple">modern</div>
                    <div class="suggestion sg-purple">vintage</div>
                    <div class="suggestion sg-purple">cozy</div>
                </div>
            </div>

            <div style="margin-bottom: 32px;">
                <label for="textbox-prefrestaurant" style="margin-left: 92px; font-size: 1.1em; color: #0000007d;">
                    for the restaurants:
                </label>
                <div class="center-h" style="margin-top: 5px; margin-bottom: 15px;">
                    <input type="text" id="textbox-prefrestaurant" class="textbox-prefrestaurant" />
                </div>
                <div style="display: flex;" class="suggestions">
                    <div class="suggestion sg-orange">italian</div>
                    <div class="suggestion sg-orange">wine</div>
                    <div class="suggestion sg-orange">price</div>
                    <div class="suggestion sg-orange">vintage</div>
                </div>
            </div>

            <div style="display: flex; float: right; margin-right: 40px; margin-bottom: 55px;" id="search-button">
                <div id="search-text-bg" onclick="displayResults();"><p id="search-text">search</p></div>
                <a href="#" onclick="displayResults(); return false;"><img src="drawables/fab_send.svg" id="search-icon" /></a>
            </div>
        </div>
    </div>

    <div id="results-page">
        <a href="#" class="actionbar-back" onclick="hideResults(); return false;"></a>
        <div id="results-contents">
            <p id="location-label"></p>
        </div>
    </div>

    <script defer>
        var serverUrl = 'http://localhost:8000/';

        let params = new URLSearchParams(location.search);
        
        var locationQuery = params.get("q");
        var hotelPrefs = params.get("hotels");
        var restaurantPrefs = params.get("restaurants");

        $('#textbox-dest').val(locationQuery);
        $('#textbox-prefhotel').val(hotelPrefs);
        $('#textbox-prefrestaurant').val(restaurantPrefs);

        if (locationQuery != null && locationQuery.length > 0) displayResults();

        authenticate();

        function setQueryVars() {
            locationQuery = $('#textbox-dest').val().replaceAll('/', ' ').replaceAll('\\', ' ');
            $('#location-label').text(locationQuery);
            hotelPrefs = $('#textbox-prefhotel').val().replaceAll('/', ' ').replaceAll('\\', ' ');
            restaurantPrefs = $('#textbox-prefrestaurant').val().replaceAll('/', ' ').replaceAll('\\', ' ');
        }
        function displayResults() {
            $('#landing-container').addClass('landing-hidden');
            $('#results-page').addClass('results-shown');
            setTimeout(function () {
                $('#landing-hidden').css('display', 'none');
            }, 500);

            setQueryVars();
            window.history.pushState('data', "Adventus", 'index.html?q=' + locationQuery + '&hotels=' + hotelPrefs + '&restaurants=' + restaurantPrefs);

            var locationSplit = locationQuery.split(',').map(function (s) {return s.trim()});
            var city = locationSplit.slice(0, -1).join(',');
            var country = locationSplit.slice(-1);
            
            $.getJSON(serverUrl + 'findhotels/' + country + '/' + city + '/' + hotelPrefs + '/?format=json', function(data) {
                for (let hotel of data) {
                    let starRatingHtml = '<div class="obj-star-ratings">';
                    for (let i = 0; i < hotel['starRating']; i++)
                    {
                        starRatingHtml += '<img src="drawables/star_icon.svg" style="height: 15px; margin-right: 20px;">';
                    }
                    if (hotel['starRating'] == null) 
                    {
                        starRatingHtml += '<img src="drawables/star_icon.svg" style="height: 15px; margin-right: 20px; opacity: 0;">';
                    }
                    starRatingHtml += '</div>';
                    let htmlDom = '<a href="' + hotel['bookingLink'] + '" target="_blank"><div class="result-card"><img src="' + hotel['linkToBookingPic'] + '" class="obj-thumb"><div class="obj-description"><p style="font-weight: bold; font-size: 1.6em; text-overflow: ellipsis; overflow: hidden; width: auto; height: 1.3em; white-space: nowrap;">' + hotel['name'] + '</p>' + starRatingHtml + '<img src="drawables/booking_redirect_button' + ((/^((?!chrome|android).)*safari/i.test(navigator.userAgent)) ? '_mac.png' : '.svg') + '" height="23px"></div></div></a>';
                    $('#results-contents').append(htmlDom);
                }
            });
            // TODO: IF ERROR
        }
        function hideResults() {
            $('#landing-container').removeClass('landing-hidden');
            $('#results-page').removeClass('results-shown');
            setTimeout(function () {
                $('#landing-hidden').css('display', 'block');
                $('#results-contents').html('<p id="location-label"></p>');
            }, 500);
            // window.history.pushState('data', "Adventus", 'index.html');
        }
        function login() {
            let email = $('#login-email').val();
            let password = $('#login-password').val();

            $.post(serverUrl + 'api/token/', { 'email': email, 'password': password }, function(data, textStatus) {
                setCookie('user_tkn', data['access'], 7);
                authenticate(false);
            }, "json").fail(function (xhr, status, error) {
                alert(JSON.parse(xhr.responseText).detail);
            });
        }
        function authenticate(mandatoryCheck = true) {
            if (mandatoryCheck) {
                $.ajax({url: serverUrl + 'test/', type: 'GET', data: {}, beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + getCookie('user_tkn'));
                }, success: function(data, textStatus) {
                    $('.user-menu').html('Welcome, <b>Nicola Nicolov</b>!<button onclick="setCookie(\'user_tkn\', \'\', 0); location.reload();" class="login-button">Log out</button>');
                }, fail: function(xhr, status, error) {
                    authenticated = false;
                    return;
                }});
            }
            if (mandatoryCheck == false) $('.user-menu').html('Welcome, <b>Nicola Nicolov</b>!<button onclick="setCookie(\'user_tkn\', \'\', 0); location.reload();" class="login-button">Log out</button>');
        }
        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            let expires = "expires="+d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }
        function getCookie(cname) {
            let name = cname + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return null;
        }
        $('.sg-purple').click(function() {
            var newHotelPrefs = $('#textbox-prefhotel').val();
            if (newHotelPrefs.length > 0 && !newHotelPrefs.endsWith(" ")) newHotelPrefs += " ";
            newHotelPrefs += $(this).text();
            $('#textbox-prefhotel').val(newHotelPrefs);
        });
        $('.sg-orange').click(function() {
            var newRestaurantPrefs = $('#textbox-prefrestaurant').val();
            if (newRestaurantPrefs.length > 0 && !newRestaurantPrefs.endsWith(" ")) newRestaurantPrefs += " ";
            newRestaurantPrefs += $(this).text();
            $('#textbox-prefrestaurant').val(newRestaurantPrefs);
        });
        $('input[type="text"]').keydown(function(event) {
            if (event.keyCode === 13) {
                displayResults();
            }
        });

    </script>
</body>